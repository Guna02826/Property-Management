# Entity Relationship Diagram

**Phase 2: Core Data Model**

Neorem - Property Management System

This document provides a text-based representation of the ER diagram. For visual diagrams, use tools like MySQL Workbench, dbdiagram.io, or draw.io

## 1. Core Hierarchy (Phase 2 Focus)

```
┌─────────────────┐
│  Organization   │
│  (Multi-tenant) │
└────────┬────────┘
         │
         │ 1
         │
         │ N
┌────────▼────────┐         ┌──────────────┐
│    Portfolio     │────────▶│     User     │
│                  │ owner_id│  (Owner)      │
└────────┬─────────┘         └──────────────┘
         │
         │ 1
         │
         │ N
┌────────▼────────┐         ┌──────────────┐
│    Property      │────────▶│     User     │
│                  │ owner_id│  (Owner)     │
└────────┬─────────┘         └──────────────┘
         │
         │ 1
         │
         │ N
┌────────▼────────┐
│      Unit        │
└──────────────────┘

Phase 2 Relationship: Portfolio → Property → Unit
```

## 2. Lease Relationships (Phase 2 Focus)

```
┌──────────────┐
│     Unit     │
└──────┬───────┘
       │
       │ 1
       │
       │ N
┌──────▼───────┐         ┌──────────────┐
│    Lease     │────────▶│    Tenant    │
│              │ tenant_id│              │
└──────────────┘         └──────┬───────┘
                                │
                                │ 1
                                │
                                │ N
                        ┌───────▼───────┐
                        │    Payment   │
                        └──────────────┘

Phase 2 Relationships:
- Unit → Tenant → Lease
- Tenant → Payment
```

## 3. Work Order Relationships (Phase 2 Focus)

```
┌──────────────┐
│     Unit     │
└──────┬───────┘
       │
       │ 0..N
       │
┌──────▼───────┐         ┌─────────────────────┐
│ Work Order   │────────▶│ Maintenance Request │
│              │         │      (Optional)      │
└──────────────┘         └──────────────────────┘

Phase 2 Relationship: Unit → Work Order
```

## 4. Complete ER Diagram (Text Format)

```
                    ┌─────────────────┐
                    │  Organization   │
                    │  (Multi-tenant) │
                    └────────┬────────┘
                             │
                ┌────────────┼────────────┐
                │            │            │
                │ 1          │ 1          │ 1
                │            │            │
                │ N          │ N          │ N
        ┌───────▼────┐  ┌────▼────┐  ┌───▼────┐
        │  Portfolio │  │ Property │  │  User │
        └──────┬─────┘  └────┬─────┘  └───┬───┘
               │             │            │
               │ 1           │ 1          │
               │             │            │
               │ N           │ N          │ N
        ┌──────▼─────────────▼────┐      │
        │         Unit             │      │
        └──────┬───────────────────┘      │
               │                          │
               │ 1                        │
               │                          │
               │ N                        │
        ┌──────▼──────┐                  │
        │    Lease    │──────────────────┘
        └──────┬──────┘  tenant_id
               │
               │ 1
               │
               │ N
        ┌──────▼──────┐
        │   Payment   │
        └─────────────┘

        ┌──────────────┐
        │     Unit     │
        └──────┬───────┘
               │
               │ 0..N
               │
        ┌──────▼───────┐
        │ Work Order   │
        └──────────────┘
```

## 5. Relationship Details

### Portfolio → Property → Unit

**Portfolio (1) ──< (N) Property**

- `portfolio_id` in Property references Portfolio.id
- One Portfolio has many Properties
- Property must belong to exactly one Portfolio

**Property (1) ──< (N) Unit**

- `property_id` in Unit references Property.id
- One Property has many Units
- Unit must belong to exactly one Property

### Unit → Tenant → Lease

**Unit (1) ──< (N) Lease**

- `unit_id` in Lease references Unit.id
- One Unit can have many Leases (historical)
- Business Rule: Unit can have only one active Lease at a time

**Tenant (1) ──< (N) Lease**

- `tenant_id` in Lease references Tenant.id
- One Tenant can have many Leases (historical)
- Business Rule: Tenant can have multiple active Leases (different units)

### Tenant → Payment

**Tenant (1) ──< (N) Payment**

- `tenant_id` in Payment references Tenant.id
- One Tenant has many Payments
- Payment must belong to exactly one Tenant

### Unit → Work Order

**Unit (0..1) ──< (N) Work Order**

- `unit_id` in Work Order references Unit.id (nullable)
- One Unit can have many Work Orders
- Work Order can be property-level (`unit_id` = NULL) or unit-level

## 6. Cardinality Notation

### One-to-Many (1:N)

- Portfolio → Property
- Property → Unit
- Unit → Lease
- Tenant → Lease
- Tenant → Payment
- Unit → Work Order

### Many-to-Many (N:M) - via join tables

- User ↔ Role (via `user_roles`)
- Role ↔ Permission (via `role_permissions`)
- User ↔ Property (via `user_property_assignments`)

## 7. Foreign Key Relationships

### Portfolio

- `organization_id` → Organization.id
- `owner_id` → User.id
- `portfolio_manager_id` → User.id (nullable)

### Property

- `organization_id` → Organization.id
- `portfolio_id` → Portfolio.id
- `owner_id` → User.id
- `property_manager_id` → User.id (nullable)

### Unit

- `organization_id` → Organization.id
- `property_id` → Property.id
- `building_id` → Building.id (nullable, optional)
- `floor_id` → Floor.id (nullable, optional)

### Tenant

- `organization_id` → Organization.id

### Lease

- `organization_id` → Organization.id
- `unit_id` → Unit.id
- `tenant_id` → Tenant.id
- `property_id` → Property.id (denormalized)

### Payment

- `organization_id` → Organization.id
- `lease_id` → Lease.id
- `tenant_id` → Tenant.id
- `property_id` → Property.id (denormalized)
- `unit_id` → Unit.id (denormalized)

### Work Order

- `organization_id` → Organization.id
- `maintenance_request_id` → Maintenance Request.id (nullable)
- `property_id` → Property.id
- `unit_id` → Unit.id (nullable)
- `tenant_id` → Tenant.id (nullable)
- `assigned_to_user_id` → User.id (nullable)
- `assigned_to_vendor_id` → Vendor.id (nullable)

### User

- `organization_id` → Organization.id
- `created_by` → User.id (self-reference, nullable)
- `updated_by` → User.id (self-reference, nullable)

### Role

- `organization_id` → Organization.id (nullable, for system roles)
- `created_by` → User.id (nullable)
- `updated_by` → User.id (nullable)

## 8. Join Tables (Many-to-Many)

### user_roles

- `user_id` → User.id
- `role_id` → Role.id
- Unique constraint: (user_id, role_id)

### role_permissions

- `role_id` → Role.id
- `permission_id` → Permission.id
- Unique constraint: (role_id, permission_id)

### user_property_assignments

- `user_id` → User.id
- `property_id` → Property.id
- `portfolio_id` → Portfolio.id (nullable)

## 9. Denormalized Fields

### Lease

- `property_id` (denormalized from Unit → Property)
  - Purpose: Performance optimization for queries

### Payment

- `property_id` (denormalized from Unit → Property)
- `unit_id` (denormalized from Lease → Unit)
  - Purpose: Performance optimization for queries

## 10. Optional Relationships

### Building (Optional Level)

- Property (0..1) ──< (N) Building
- Building (1) ──< (N) Floor
- Floor (1) ──< (N) Unit

### Maintenance Request → Work Order

- Maintenance Request (0..1) ──< (1) Work Order
  (Work order can be created independently or from request)

## 11. Visual Diagram Tools

### Recommended Tools

1. MySQL Workbench - Reverse engineer from database
2. dbdiagram.io - Online ER diagram tool
3. draw.io / diagrams.net - General diagramming
4. Lucidchart - Professional diagramming
5. ERDPlus - Online ER diagram tool

### Export Formats

- SQL DDL (for database creation)
- PNG/SVG (for documentation)
- PDF (for printing)

## 12. Phase 2 Relationship Summary

### Core Hierarchy

```
Portfolio (1) ──< (N) Property (1) ──< (N) Unit
```

### Lease Chain

```
Unit (1) ──< (N) Lease ──< (N) Tenant (1) ──< (N) Payment
```

### Work Order

```
Unit (0..N) ──< (N) Work Order
```

All relationships are properly defined with:

- Foreign key constraints
- Appropriate indexes
- Cascade/restrict rules
- Business rule validations

## 13. Sales & Visits Relationships

```
┌──────────────┐
│  Sales Rep  │
└──────┬───────┘
       │
       │ 1
       │
       │ N
┌──────▼──────────┐         ┌──────────────┐
│ Property Visit  │────────▶│    Client    │
│                 │ client_id│              │
└──────┬──────────┘         └──────┬───────┘
       │                           │
       │ 1                         │ 1
       │                           │
       │ N                         │ N
┌──────▼──────────┐         ┌──────▼──────────┐
│    Property     │         │Client Property  │
│                 │         │    Interest     │
└─────────────────┘         └─────────────────┘

┌──────────────┐
│  Sales Rep  │
└──────┬───────┘
       │
       │ 1
       │
       │ N
┌──────▼──────────┐
│ Sales Rep Leave │
└─────────────────┘
```

## 14. Canteen Relationships

```
┌──────────────┐
│   Property   │
└──────┬───────┘
       │
       │ 1
       │
       │ N
┌──────▼──────────┐         ┌──────────────┐
│    Canteen      │────────▶│   Canteen     │
│                 │         │   Agreement   │
└─────────────────┘         └──────┬────────┘
                                    │
                            ┌───────┴───────┐
                            │               │
                    ┌───────▼────┐  ┌──────▼──────┐
                    │   Client   │  │   Tenant   │
                    └────────────┘  └─────────────┘
```

## 15. Parking Space Relationships

```
┌──────────────┐
│   Property   │
└──────┬───────┘
       │
       │ 1
       │
       │ N
┌──────▼──────────┐
│ Parking Space   │
│                 │
│ - unit_id (O)   │
│ - client_id (O) │
│ - owner_id (O)  │
└─────────────────┘
```

## 16. Parent-Child Deletion Behavior

### Deletion Rules

**Detach Child (Default Behavior):**
- When deleting a child entity, the parent relationship is detached (parent_id set to NULL)
- Child entity remains in database with NULL parent reference
- Example: Deleting Property detaches Units (unit.property_id = NULL)

**Cascade Delete (Explicit):**
- When deleting a parent entity, option to delete all children or detach them
- Requires explicit confirmation for cascade operations
- Example: Deleting Portfolio can cascade delete Properties if explicitly requested

**Business Rules:**
- Portfolio → Property: Detach by default, cascade optional
- Property → Unit: Detach by default, cascade optional
- Unit → Lease: Cannot delete Unit with active Lease (must terminate lease first)
- All deletions are soft deletes (deleted_at timestamp)
- Recycle bin: All deleted records stored with deleted_at timestamp
- Permanent deletion: Only Super Admin can permanently delete from recycle bin

## Summary

**Phase 2 Core Entities:** 9

- Portfolio, Property, Unit, Tenant, Lease, Payment, Work Order, User, Role

**Additional Entities:** 8

- Sales Representative, Property Visit, Sales Rep Leave, Client Property Interest, Canteen, Canteen Agreement, Parking Space, Client

**Phase 2 Core Relationships:** 4

- Portfolio → Property → Unit
- Unit → Tenant → Lease
- Tenant → Payment
- Unit → Work Order

**Additional Relationships:** 6

- Sales Rep → Property Visit → Client
- Client → Property Interest
- Property → Canteen → Canteen Agreement
- Property → Parking Space (with client/owner assignment)

All relationships documented with:

- Cardinality
- Foreign key definitions
- Business rules
- Denormalization notes
- Deletion behavior (detach vs cascade)

